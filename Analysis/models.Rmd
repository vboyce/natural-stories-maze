---
title: "Natural Stories model analyses"
output: 
  html_document:
    toc: true
---

# Prep

```{r, include=F}
knitr::opts_chunk$set(echo = FALSE, warning=F, message=F)
options(knitr.table.format = "html")
knitr::opts_chunk$set(dev = "png", dev.args = list(type = "cairo-png"))
library(plyr)
library(tidyverse)
library(readr)
library(brms)
library(lme4)
library(rstan)
library(tidybayes)
library(knitr)
library(mgcv)
library(mgcViz)
library(tidymv)
library(rsample)
library(cowplot)
library(scales)
library(ggstance)
library(here)
theme_set(theme_bw())
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

# Maze Prep

```{r maze-participants}

data <- read_rds(here("Data/cleaned.rds"))

data_filt <- data %>% filter(native %in% c("ENG", "English", "ENGLISH", "english")) #I peeked at what people put that semantically maps to english

data_error_summ <- data_filt %>% 
  mutate(correct.num=ifelse(correct=="yes", 1,0)) %>% 
  group_by(subject) %>%
  filter(type!="practice") %>% 
  filter(rt<5000) %>% 
  summarize(pct_correct=mean(correct.num)) %>% 
  ungroup() %>% 
  mutate(is.attentive=ifelse(pct_correct>.8, T,F)) %>% 
  select(subject, is.attentive)

data_low_error <- data_filt %>% 
  left_join(data_error_summ, by="subject") %>% 
  filter(is.attentive) %>% 
  filter(type!="practice")

  data_error_free <- data_low_error %>% 
    mutate(word_num_mistake=ifelse(correct=="no", word_num,NA)) %>% 
    group_by(sentence, subject) %>% fill(word_num_mistake) %>% ungroup() %>% 
    mutate(after_mistake=word_num-word_num_mistake,
           after_mistake=ifelse(is.na(after_mistake),0,after_mistake)) %>% 
    filter(correct=="yes") %>% 
    filter(!after_mistake %in% c(1,2))
  
data_no_first <- data_error_free %>% filter(word_num!=0)

data_ready <- data_no_first %>% filter(rt>100 & rt<5000) %>% 
  select(subject, word_num, word, rt, sentence, type)

data_pre_error <- data_no_first %>% filter(rt>100 & rt<5000) %>% 
  filter(after_mistake==0) %>% 
  select(subject, word_num, word, rt, sentence, type) %>% write_rds(here("Data/maze_pre_error.rds"))

data_stories <- data_ready %>% select(type, subject) %>% 
  unique() %>% 
  group_by(type) %>% 
  tally()
```

```{r labels}
labs <- read_rds(here("Prep_code/natural_stories_surprisals.rds")) %>% 
  left_join(read_delim(here("Materials/natural_stories_sentences.tsv"), delim="\t")) %>% 
  select(word_num=Word_In_Sentence_Num, word=Word, sentence=Sentence, everything())

select_labs <- labs %>% 
  mutate(across(ends_with("surp"),~ifelse(ngram_token_count==1 & txl_token_count==1 & grnn_token_count==1 & gpt_token_count==1 & word_num>0, .x, NA))) %>% 
  select(-ends_with("token_count")) %>% 
    mutate(txl_center=txl_surp-mean(txl_surp, na.rm=T),
         ngram_center=ngram_surp-mean(ngram_surp, na.rm=T),
         grnn_center=grnn_surp-mean(grnn_surp, na.rm=T),
         freq_center=freq-mean(freq, na.rm=T),
         length_center=length-mean(length, na.rm=T),
         gpt_center=gpt_surp-mean(gpt_surp, na.rm=T)) %>% 
  group_by(sentence,Story_Num,Sentence_Num) %>% 
  mutate(across(txl_surp:gpt_center,.names="past_{.col}", lag),
         across(txl_surp:gpt_center,.names="past2_{.col}", ~lag(.x,n=2)),
         across(txl_surp:gpt_center,.names="past3_{.col}", ~lag(.x,n=3)))

```

```{r}


labelled_pre_error <- data_pre_error %>% inner_join(select_labs, by=c("word_num", "word", "sentence")) %>%
  filter(word_num>1) %>% 
  mutate(Word_ID=as_factor(str_c(Story_Num, Word_In_Story_Num, sep="_")))%>% write_rds(here("Data/maze_pre_error.rds"))

```

```{r maze-item-means}

select_data <- read_rds(here("Data/maze_pre_error.rds")) %>%  select(-starts_with("past2"), -starts_with("past3")) %>% 
  filter(across(everything(),~!is.na(.x))) 


item_mean_data <- select_data %>% 
  group_by(across(c(-subject, -rt))) %>% 
  summarize(rt=mean(rt)) %>% 
  ungroup()


```



# Maze GAMs

```{r maze-prep-gam}
#on meaned data
ngram_mean_data <- item_mean_data %>% select(rt, surprisal=ngram_surp, prev_surp=past_ngram_surp, 
                                            freq=freq_center, len=length_center,
                                            prev_freq=past_freq_center, prev_len=past_length_center
                                            ) %>% mutate(model="5-gram")

grnn_mean_data <- item_mean_data %>% select(rt, surprisal=grnn_surp, prev_surp=past_grnn_surp, 
                                            freq=freq_center, len=length_center,
                                            prev_freq=past_freq_center, prev_len=past_length_center
                                            )%>% mutate(model="GRNN")

txl_mean_data <- item_mean_data %>% select(rt, surprisal=txl_surp, prev_surp=past_txl_surp, 
                                            freq=freq_center, len=length_center,
                                            prev_freq=past_freq_center, prev_len=past_length_center
                                            ) %>% mutate(model="TXL")

gpt_mean_data <- item_mean_data %>% select(rt, surprisal=gpt_surp, prev_surp=past_gpt_surp, 
                                            freq=freq_center, len=length_center,
                                            prev_freq=past_freq_center, prev_len=past_length_center
                                            ) %>% mutate(model="GPT-2")

all_mean_data <- ngram_mean_data %>% union(grnn_mean_data) %>% union(txl_mean_data) %>% union(gpt_mean_data) %>% 
  select(surprisal, prev_surp,model) %>% 
  pivot_longer(cols=`surprisal`:`prev_surp`) %>% 
  mutate(s=ifelse(name=="surprisal", "Current","Previous")) %>% write_rds(here("Analysis/models/meaned_maze.rds"))
```

```{r maze-formulae, echo=T}

#no hierarchical, has freq x len interaction
formula_no_interact_linear_surprisal <- rt ~ surprisal +
                     ti(freq, bs="cr") + 
                     ti(len, bs="cr")+
                     ti(freq,len, bs="cr")+
                     prev_surp +
                     ti(prev_freq, bs="cr")+
                     ti(prev_len, bs="cr")+
                     ti(prev_freq, prev_len, bs="cr")

# no hierarchical, NO freq x len interaction
formula_no_interact_plus_linear_surprisal <- rt ~ surprisal +
                     s(surprisal, bs="cr", k=20)+
                     ti(freq, bs="cr") + 
                     ti(len, bs="cr")+
                     prev_surp +
                     s(prev_surp, bs="cr", k=20)+
                     ti(prev_freq, bs="cr")+
                     ti(prev_len, bs="cr")


#no hierarchical, has freq x len interaction
formula_interact <- rt ~ s(surprisal, bs="cr", k=20)+
                     ti(freq, bs="cr") + 
                     ti(len, bs="cr")+
                     ti(freq,len, bs="cr")+
                     s(prev_surp, bs="cr", k=20)+
                     ti(prev_freq, bs="cr")+
                     ti(prev_len, bs="cr")+
                     ti(prev_freq, prev_len, bs="cr")

# no hierarchical, NO freq x len interaction
formula_no_interact <- rt ~ s(surprisal, bs="cr", k=20)+
                     ti(freq, bs="cr") + 
                     ti(len, bs="cr")+
                     s(prev_surp, bs="cr", k=20)+
                     ti(prev_freq, bs="cr")+
                     ti(prev_len, bs="cr")


formula3_interact <- rt ~ ti(surprisal, bs="cr", k=20)+
                     ti(freq, bs="cr") + 
                     ti(len, bs="cr")+
                     ti(freq,len, bs="cr")+
                     ti(surprisal,len, bs="cr")+
                     ti(surprisal,freq, bs="cr")+
                     ti(prev_surp, bs="cr", k=20)+
                     ti(prev_freq, bs="cr")+
                     ti(prev_len, bs="cr")+
                     ti(prev_freq, prev_len, bs="cr") +
                     ti(prev_surp, prev_len, bs="cr") +
                     ti(prev_surp, prev_freq, bs="cr")

formula2_interact <- rt ~ 
                     ti(freq,len, bs="cr")+
                     ti(surprisal,len, bs="cr")+
                     ti(surprisal,freq, bs="cr")+
                     ti(prev_freq, prev_len, bs="cr") +
                     ti(prev_surp, prev_len, bs="cr") +
                     ti(prev_surp, prev_freq, bs="cr")
```

All of this is on by-item mean data. 

```{r meaned data, eval=T, cache=T}
gam_ngram_1 <- gam(formula_interact, data=ngram_mean_data, method="REML")
gam_grnn_1 <- gam(formula_interact, data=grnn_mean_data, method="REML")
gam_txl_1 <- gam(formula_interact, data=txl_mean_data, method="REML")
gam_gpt_1 <- gam(formula_interact, data=gpt_mean_data, method="REML")
#gam_gpt_1a <- gam(formula_interact, data=filter(gpt_mean_data,len<9), method="REML")
gam_gpt_2 <- gam(formula2_interact, data=gpt_mean_data, method="REML")
gam_gpt_3 <- gam(formula3_interact, data=gpt_mean_data, method="REML")

#gam_gpt_3_hf <- gam(formula3_interact, data=subset(gpt_mean_data,freq > 2), method="REML")
#gam_gpt_3_lf <- gam(formula3_interact, data=subset(gpt_mean_data,freq <= 2), method="REML")

#gam_gpt_2_hf <- gam(formula2_interact, data=subset(gpt_mean_data,freq > 2), method="REML")
#gam_gpt_2_lf <- gam(formula2_interact, data=subset(gpt_mean_data,freq <= 2), method="REML")


gam_ngram_2 <- gam(formula_no_interact, data=ngram_mean_data, method="REML")
gam_grnn_2 <- gam(formula_no_interact, data=grnn_mean_data, method="REML")
gam_txl_2 <- gam(formula_no_interact, data=txl_mean_data, method="REML")
gam_gpt_no_interact <- gam(formula_no_interact, data=gpt_mean_data, method="REML")
gam_gpt_no_interact_plus_linear_surprisal <- gam(formula_no_interact_plus_linear_surprisal, data=gpt_mean_data, method="REML")

#print(plot(getViz(gam_gpt_1a)))
print(plot(getViz(gam_gpt_no_interact)))
print(plot(getViz(gam_gpt_2)))
summary(gam_gpt_3)

summary(getViz(gam_gpt_3_hf))
print(plot(getViz(gam_gpt_3_hf)))
print(plot(getViz(gam_gpt_2_hf)))


summary(getViz(gam_gpt_3_lf))
print(plot(getViz(gam_gpt_3_lf)))

summary(gam_gpt_no_interact_plus_linear_surprisal)
```
## Extract linearity comparisons

```{r}
make_gam_linear_summary <- function(data){
  model <- gam(formula_no_interact_plus_linear_surprisal, data=data, method="REML")
  summ <- summary(model)
  stable <- summ$s.table %>% as_tibble(rownames="Term") %>% rename(pvalue=`p-value`) %>% select(Term, pvalue)
  ptable <- summ$p.table %>% as_tibble(rownames="Term") %>% rename(pvalue=`Pr(>|t|)`) %>% select(Term, pvalue)
  return(union(stable,ptable))
}

gpt_linear <- make_gam_linear_summary(gpt_mean_data) %>% mutate(model="GPT-2")
ngram_linear <- make_gam_linear_summary(ngram_mean_data) %>% mutate(model="5-gram")
txl_linear <-  make_gam_linear_summary(txl_mean_data) %>% mutate(model="TXL")
grnn_linear <-  make_gam_linear_summary(grnn_mean_data) %>% mutate(model="GRNN") 

all_linear <- gpt_linear %>% union(ngram_linear) %>% union(txl_linear) %>% union(grnn_linear) %>% mutate(pvalue=pvalue(pvalue,accuracy=.0001,add_p=T),model=factor(model, levels=c("5-gram", "GRNN", "TXL","GPT-2")))%>% arrange(model) %>% 
  pivot_wider(names_from=model, values_from=pvalue) %>% write_rds(here("Analysis/models/gams_linearity_test.rds"))
```

```{r}
gam_gpt_3 <- gam(formula3_interact, data=gpt_mean_data, method="REML")
  stable <- summary(gam_gpt_3)$s.table %>% as_tibble(rownames="Term") %>% rename(pvalue=`p-value`, `F-statistic`=`F`) %>% select(Term, `F-statistic`, pvalue) %>% mutate(`F-statistic`=signif(`F-statistic`,digits=4), pvalue=pvalue(pvalue,accuracy=.0001,add_p=T)) %>% 
    write_rds(here("Analysis/models/gam_gpt_3_summ.rds"))

```

## Pretty interaction pics
```{r fig.width=6, fig.height=8,}

#gam_gpt_3 <- gam(formula3_interact, data=gpt_mean_data, method="REML")

#gam_gpt_interact <- getViz(gam_gpt_3) %>% write_rds(here("Analysis/models/gam_gpt_interact.rds"))

# can't figure out how to adjust the number of rows cols using the default, so we instead copy their internal functions off github and hack

addDefaultLayers <- function( .l ){
    .cl <- paste(.l$type, collapse = '')
    
    if( grepl("Check", .cl) ){ # [A] Checking plots
      if("qgam" %in% mcls){ # a.1 Quantile GAMS
        .l <- switch(.cl, 
                     "Check0DScalarNumeric" = .l + l_hist() + l_vline(),
                     "Check0DScalarFactor" = .l + l_hist() + l_vline(),
                     "Check0DScalarLogical" = .l + l_hist() + l_vline(),
                     "Check0DVectorNumeric" = .l + l_hist(),
                     "Check0DVectorFactor" = .l + l_hist(),
                     "Check0DVectorLogical" = .l + l_hist(),
                     "Check1DNumeric" =  .l + l_gridQCheck1D() + l_rug(), 
                     "Check1DFactor" = .l + l_gridQCheck1D() + l_rug(),
                     "Check1DLogical" = .l + l_gridQCheck1D() + l_rug(),
                     "Check2DNumericNumeric" = .l + l_gridQCheck2D(),
                     "Check2DFactorFactor" = .l + l_gridQCheck2D() + l_rug(),
                     "Check2DFactorNumeric" = .l + l_gridQCheck2D() + l_rug(),
                     .l
        )
      } else { # a.2 Standard GAMS
        .l <- switch(.cl, 
                     "Check0DScalarNumeric" = .l + l_hist() + l_vline(),
                     "Check0DScalarFactor" = .l + l_hist() + l_vline(),
                     "Check0DScalarLogical" = .l + l_hist() + l_vline(),
                     "Check0DVectorNumeric" = .l + l_hist(),
                     "Check0DVectorFactor" = .l + l_hist(),
                     "Check0DVectorLogical" = .l + l_hist(),
                     "Check1DNumeric" =  .l + l_dens2D("cond") + l_gridCheck1D(mean, showReps = FALSE), 
                     "Check1DFactor" = .l + l_gridCheck1D(showReps = FALSE) + l_rug(),
                     "Check1DLogical" = .l + l_gridCheck1D(showReps = FALSE) + l_rug(),
                     "Check2DNumericNumeric" = .l + l_gridCheck2D(),
                     "Check2DFactorFactor" = .l + l_gridCheck2D() + l_rug(),
                     "Check2DFactorNumeric" = .l + l_gridCheck2D() + l_rug(),
                     .l
        )
      }
    } else { # [B] Smooth effect plots
    
    .l <- switch(.cl, 
                 "singleIndex1D" = .l + l_fitLine() + l_ciLine() + l_rug(), 
                 "fs1D" = .l + l_fitLine() + theme(legend.position="none"),
                 "1D" = .l + l_fitLine() + l_ciLine() + l_rug(),
                 "2D" = .l + l_fitRaster() + l_fitContour(), 
                 "MD" = .l + l_fitRaster() + l_fitContour(), 
                 "MDslice" = .l + l_fitRaster() + l_fitContour(), 
                 "sos0" = .l + l_fitRaster() + l_fitContour(), 
                 "sos1" = .l + l_fitRaster() + l_fitContour(),
                 "randomEffect" = .l + l_fitLine() + l_ciLine() + l_points(), 
                 "MultiRandomEffect" = .l + l_points(), 
                 "mrf" = .l + l_poly(), 
                 "PtermNumeric" = .l + l_fitLine() + l_ciLine() + l_rug(),
                 "PtermFactor" = .l + l_ciBar() + l_fitPoints() + l_rug(),
                 "PtermLogical" = .l + l_ciBar() + l_fitPoints() + l_rug(), 
                 "PtermMatrixNumeric" = .l + l_fitLine() + l_ciLine(),
                 "Multi1D" = .l + l_fitLine(),
                 "Multi2D" = .l + l_fitRaster() + l_fitContour(),
                 "MultiPtermNumeric" = .l + l_ciBar() + l_fitPoints(),
                 "MultiPtermFactor" = .l + l_ciBar() + l_fitPoints(), 
                 "ALE1DNumeric" = .l + l_fitLine() + l_ciLine() + l_rug(),
                 "ALE1DFactor" = .l + l_ciBar() + l_fitPoints() + l_rug(),
                  .l
                 )
    
    }
    
    return( .l )
  }

g <- read_rds(here("Analysis/models/gam_gpt_interact.rds")) %>% plot()
g$plots <- lapply(g$plots,   function(.l){
                         addDefaultLayers(.l)
                       })



blah <-  arrangeGrob(grobs=read_rds(here("Analysis/models/draft_grid.rds")), ncol=3, )

ggsave(here("Analysis/models/gam_grid.png"), blah)



```

```{r anovas, eval=T}

anova(gam_ngram_1,gam_ngram_2, test="Chisq")
anova(gam_grnn_1,gam_grnn_2, test="Chisq")
anova(gam_txl_1,gam_txl_2, test="Chisq")
anova(gam_gpt_1,gam_gpt_2, test="Chisq")
```


```{r maze bootstrap code, eval=F}
require(OpenImageR)
gam_boot <- function(dat,formula,data_frames_for_prediction,N=100,method="REML",...) {
  models <- lapply(1:N,function(seed) {
    set.seed(seed)
    #dat[[weights_name]] <- tabulate(sample(1:nrow(dat),floor(nrow(dat)/5),replace=TRUE),nbins=nrow(dat))
    dat$mgcv_weights <- tabulate(sample(1:nrow(dat),nrow(dat),replace=TRUE),nbins=nrow(dat))
    #print(head(dat$mgcv_weights))
    #print(head(dat[[weights_name]]))
    #m <- gam(formula,data=dat,weights=dat[[weights_name]],...)
    m <- gam(formula,data=dat,weights=mgcv_weights,method=method,...)
    #print(m$deviance)
    return(m)
  })
  results <- lapply(names(data_frames_for_prediction),function(term) {
    predictions <-sapply(models,function(m)
      predict(m,newdata=data_frames_for_prediction[[term]],type="terms",terms=term))
    #print(dim(predictions))
    return(predictions)
  })
  #print(length(results))
  names(results) <- names(data_frames_for_prediction)
  return(results)
}

summarize_gam_boot_results <- function(gam_boot_results,data_frames_for_prediction,term_names,model_name,point_estimation_function=mean,quantiles=c(0.025,0.975)) {
  result <- lapply(1:length(data_frames_for_prediction),function(i) {
    #print(cat(i,"\t",term_names[[i]]))
    res <- tibble(x=data_frames_for_prediction[[i]][[term_names[[i]]]],
                  rt=apply(gam_boot_results[[i]],1,point_estimation_function),
                  CI_lower=apply(gam_boot_results[[i]],1,function(x) quantile(x,quantiles[1])),
                  CI_upper=apply(gam_boot_results[[i]],1,function(x) quantile(x,quantiles[2])),
                  model=model_name,
                  term=term_names[[i]]
                  )
    names(res)[names(res)=="x"] <- term_names[[i]]
    return(res)
  })
  return(result)
}

dat_for_surprisal_prediction <- expand_grid(surprisal=seq(0,25,by=0.01),freq=0,len=0,prev_surp=0,prev_freq=0,prev_len=0)
dat_for_freq_prediction <- expand_grid(surprisal=0,freq=seq(-9.5,7,by=0.01),len=0,prev_surp=0,prev_freq=0,prev_len=0)
dat_for_length_prediction <- expand_grid(surprisal=0,freq=0,len=seq(-3.4,10.6,by=0.01),prev_surp=0,prev_freq=0,prev_len=0)
dat_for_prev_surp_prediction <- expand_grid(surprisal=0,freq=0,len=0,prev_surp=seq(0,25,by=0.01),prev_freq=0,prev_len=0)
dat_for_prev_freq_prediction <- expand_grid(surprisal=0,freq=0,len=0,prev_surp=0,prev_freq=seq(-9.5,7,by=0.01),prev_len=0)
dat_for_prev_len_prediction <- expand_grid(surprisal=0,freq=0,len=0,prev_surp=0,prev_freq=0,prev_len=seq(-3.4,10.6,by=0.01))
#predict(m,newdata=dat_for_surprisal_prediction,type="terms",terms='s(surprisal)')
#predict(m,newdata=dat_for_freq_prediction,type="terms",terms='ti(freq)')
term_names <- c("surprisal","freq","len","prev_surp","prev_freq","prev_len")
dats_for_prediction <- list(
  's(surprisal)'=dat_for_surprisal_prediction,
  'ti(freq)'=dat_for_freq_prediction,
  'ti(len)'=dat_for_length_prediction,
  's(prev_surp)'=dat_for_prev_surp_prediction,
  'ti(prev_freq)'=dat_for_prev_freq_prediction,
  'ti(prev_len)'=dat_for_prev_len_prediction)
N_replicates <- 101
res_ngram <- gam_boot(ngram_mean_data,formula_no_interact,dats_for_prediction,N=N_replicates)
bootstrapped_gam_predictions_ngram <- summarize_gam_boot_results(res_ngram,dats_for_prediction,term_names,"5-gram")
res_grnn <- gam_boot(grnn_mean_data,formula_no_interact,dats_for_prediction,N=N_replicates)
bootstrapped_gam_predictions_grnn <- summarize_gam_boot_results(res_grnn,dats_for_prediction,term_names,"GRNN")
res_txl <- gam_boot(txl_mean_data,formula_no_interact,dats_for_prediction,N=N_replicates)
bootstrapped_gam_predictions_txl <- summarize_gam_boot_results(res_txl,dats_for_prediction,term_names,"Transformer-XL")
res_gpt <- gam_boot(gpt_mean_data,formula_no_interact,dats_for_prediction,N=N_replicates)
bootstrapped_gam_predictions_gpt <- summarize_gam_boot_results(res_gpt,dats_for_prediction,term_names,"GPT-2")
all_bootstrapped_predictions <- list(ngram=bootstrapped_gam_predictions_ngram,
                                     grnn=bootstrapped_gam_predictions_grnn,
                                     txl=bootstrapped_gam_predictions_txl,
                                     gpt=bootstrapped_gam_predictions_gpt)
all_surprisal_predictions <- rbind(bootstrapped_gam_predictions_ngram[[1]],
                                   rename(bootstrapped_gam_predictions_ngram[[4]],surprisal=prev_surp),
                                   bootstrapped_gam_predictions_grnn[[1]],
                                   rename(bootstrapped_gam_predictions_grnn[[4]],surprisal=prev_surp),
                                   bootstrapped_gam_predictions_txl[[1]],
                                   rename(bootstrapped_gam_predictions_txl[[4]],surprisal=prev_surp),
                                   bootstrapped_gam_predictions_gpt[[1]],
                                   rename(bootstrapped_gam_predictions_gpt[[4]],surprisal=prev_surp)
                                   ) %>%
  mutate(s=ifelse(term=="surprisal","Current","Previous")) %>%
  select(-term)

write_rds(all_bootstrapped_predictions,here("Analysis/models/bootstrapped_GAM_predictions.rds"))
write_rds(all_surprisal_predictions,here("Analysis/models/bootstrapped_GAM_surprisal_predictions.rds"))


dats_for_predictionX <- list(
  'ti(surprisal)'=dat_for_surprisal_prediction,
  'ti(freq)'=dat_for_freq_prediction,
  'ti(len)'=dat_for_length_prediction,
  'ti(prev_surp)'=dat_for_prev_surp_prediction,
  'ti(prev_freq)'=dat_for_prev_freq_prediction,
  'ti(prev_len)'=dat_for_prev_len_prediction)
system.time(res_gptX <- gam_boot(gpt_mean_data,formula2_interact,dats_for_predictionX,N=N_replicates))
bootstrapped_gam_predictions_gptX <- summarize_gam_boot_results(res_gpt,dats_for_predictionX,term_names,"GPT-2")
write_rds(res_gptX,"res_gptX.rds")
write_rds(bootstrapped_gam_predictions_gptX,"bootstrapped_gam_predictions_gptX.rds")
```

```{r example bootstrap results,eval=F}
# as an example, plot effect for surprisal
summaries <- bootstrapped_gam_predictions_gptX
summaries <- bootstrapped_gam_predictions_grnn
ggplot(summaries[[1]],aes(x=surprisal,y=rt)) + geom_line() +
  #geom_rug(aes(x=grnn_mean_data$surprisal),sides='b') +
  geom_line(aes(x=summaries[[1]]$surprisal,y=summaries[[1]]$CI_lower),linetype="dashed") +
  geom_line(aes(x=summaries[[1]]$surprisal,y=summaries[[1]]$CI_upper),linetype="dashed") +
  ylim(c(-200,600)) +
  xlab("surprisal") +
  ylab("RT contribution") +
  theme(aspect.ratio=1)
ggsave("/tmp/bootstrap.pdf")
```

```{r example non-bootstrap results, eval=F}
m_no_bootstrap <- gam(formula_no_interact,data=grnn_mean_data)
plot(m_no_bootstrap,select=1,ylim=c(-200,600))
pdf("/tmp/no_bootstrap.pdf")
plot(m_no_bootstrap,select=1,ylim=c(-200,600))
dev.off()
```

```{r plots, eval=F}
message("GPT")
plot(gam_gpt_1)
message("GRNN")
plot(gam_grnn_1)
message("TXL")
plot(gam_txl_1)
message("NGRAM")
plot(gam_ngram_1)

```

For the length: frequency interaction, it looks like the effect is ~ 0 for most of the space where there's actually data, and it only goes off the rails in the region where there isn't data. 

<!--Below is all words with centered frequency < -6 and centered_length > 4. Most of these are I think are recognizable as words. -->
```{r}
# select_data %>% select(word,  freq_center, length_center, sentence) %>% unique() %>% 
#   arrange(freq_center) %>% 
#   filter(freq_center< -6 & length_center > 4) %>% knitr::kable()
```




```{r plot-gam, eval=F}


a <- get_gam_predictions(model=gam_ngram_1, series=surprisal, series_length=100) %>% select(surprisal, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="5-gram", s="Current")
b <- get_gam_predictions(model=gam_ngram_1, series=prev_surp, series_length=100) %>% select(surprisal=prev_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="5-gram", s="Previous")
c <- get_gam_predictions(model=gam_grnn_1, series=surprisal, series_length=100) %>% select(surprisal, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="GRNN", s="Current")
d <- get_gam_predictions(model=gam_grnn_1, series=prev_surp, series_length=100) %>% select(surprisal=prev_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="GRNN", s="Previous")
e <- get_gam_predictions(model=gam_txl_1, series=surprisal, series_length=100) %>% select(surprisal, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="TXL", s="Current")
f <- get_gam_predictions(model=gam_txl_1, series=prev_surp, series_length=100) %>% select(surprisal=prev_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="TXL", s="Previous")
g <- get_gam_predictions(model=gam_gpt_1, series=surprisal, series_length=100) %>% select(surprisal, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="GPT-2", s="Current")
h <- get_gam_predictions(model=gam_gpt_1, series=prev_surp, series_length=100) %>% select(surprisal=prev_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="GPT-2", s="Previous")
all <- a %>% union(b) %>% union(c) %>% union(d) %>% union(e) %>% union(f) %>% union(g) %>% union(h) %>% 
  mutate(model=factor(model, levels=c("5-gram", "GRNN", "TXL","GPT-2"))) %>% 
                        write_rds(here("Analysis/models/gam_predictions.rds"))
```

```{r, eval=T}


#gam1 <- read_rds(here("Analysis/models/gam_predictions.rds")) %>%  
gam1 <- read_rds(here("Analysis/models/bootstrapped_GAM_surprisal_predictions.rds")) %>%  
  ggplot( aes(x=surprisal, y=rt, ymin=CI_lower, ymax=CI_upper))+
  geom_line()+
  geom_ribbon(alpha=.3)+
  #facet_grid(s~model, scales="free_y")+
  facet_grid(s~model)+
  coord_cartesian(xlim=c(0,28))+
  labs(x="Surprisal (bits)", y="Reaction Time (ms)")+theme(axis.ticks.x=element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), plot.margin=margin(t=0,r=0,b=0,l=0,unit="pt"))


dens2 <-   ggplot(all_mean_data, aes(x=value))+
  geom_density(fill="gray",)+
  facet_grid(.~model)+
  labs(x="Surprisal (bits)", y="")+
    coord_cartesian(xlim=c(0,28))+
  theme(axis.text.y = element_blank(), strip.text=element_blank(), axis.ticks.y =element_blank(), axis.title.y=element_blank(), panel.grid=element_blank(), plot.margin = unit(c(0, 0, 0, 0), "cm"))

p2 = cowplot::align_plots(gam1, dens2, align = "v", axis="lr")
plot_grid(p2[[1]], p2[[2]], nrow=2, rel_heights = c(1, .3))


#confirm that this really is just a prettied up version of what the usual output is
#plot(gam_txl_1, seWithMean = TRUE, shift = coef(gam_txl_1)[1], select=1)

```

# Maze LMs

```{r for brms}

ngram_data <- labelled_pre_error %>% select(rt, surprisal=ngram_center, prev_surp=past_ngram_center, 
                                            freq=freq_center, len=length_center,
                                            prev_freq=past_freq_center, prev_len=past_length_center, subject, Word_ID
                                            ) %>% mutate(model="5-gram") 
grnn_data <- labelled_pre_error %>% select(rt, surprisal=grnn_center, prev_surp=past_grnn_center, 
                                            freq=freq_center, len=length_center,
                                            prev_freq=past_freq_center, prev_len=past_length_center, subject, Word_ID
                                            )%>% mutate(model="GRNN")

txl_data <- labelled_pre_error %>% select(rt, surprisal=txl_center, prev_surp=past_txl_center, 
                                            freq=freq_center, len=length_center,
                                            prev_freq=past_freq_center, prev_len=past_length_center, subject, Word_ID
                                            ) %>% mutate(model="TXL")

gpt_data <- labelled_pre_error %>% select(rt, surprisal=gpt_center, prev_surp=past_gpt_center, 
                                            freq=freq_center, len=length_center,
                                            prev_freq=past_freq_center, prev_len=past_length_center, subject, Word_ID
                                            ) %>% mutate(model="GPT-2")

all_data <- ngram_data %>% union(grnn_data) %>% union(txl_data) %>% union(gpt_data) %>% 
  write_rds(here("Analysis/models/maze_pre_brms.rds"))

```


```{r run brms, eval=F}
# Note this was actually run on a cluster with a separate script that just had this
data=readRDS("maze_pre_brms.rds")
 priors <- c(
      set_prior("normal(1000, 1000)", class="Intercept"),
      set_prior("normal(0, 500)", class="b"),
      set_prior("normal(0, 500)", class="sd"),
      set_prior("lkj(1)",       class="cor"))
run_model <- function(model_spec,data,file_name){
  d <- data %>% filter(model==model_spec)
  m1 <- brm(rt ~ surprisal * len + freq * len +
              prev_surp * prev_len + prev_freq * prev_len+
              (surprisal * len + freq * len +
              prev_surp * prev_len + prev_freq * prev_len|subject)+(1|Word_ID),
            data=d,
            file=file_name,
            prior=priors,
            control=list(adapt_delta=.95))
}

run_model("5-gram",data,"5-gram_maze")
run_model("GRNN",data,"grnn_maze")
run_model("TXL",data,"txl_maze")
run_model("GPT-2",data,"gpt_maze")


```

```{r summary}

show_summary <- function(model){
  intervals <- gather_draws(model, `b_.*`, regex=T) %>% mean_qi()
  
  stats <- gather_draws(model, `b_.*`, regex=T) %>% 
    mutate(above_0=ifelse(.value>0, 1,0)) %>% 
    group_by(.variable) %>% 
    summarize(pct_above_0=mean(above_0)) %>% 
    mutate(`P` = signif(2*pmin(pct_above_0,1-pct_above_0), digits=2)) %>% 
    left_join(intervals, by=".variable") %>% 
    mutate(lower=round(.lower, digits=1),
           upper=round(.upper, digits=1),
           E=round(.value, digits=1),
           `Estimate`=str_c(E," [",lower,", ", upper,"]"),
           Term=str_sub(.variable, 3, -1),
           ) %>% 
    select(Term, `Estimate`)
  
  stats
}
```

```{r process-maze-models, eval=F}
ngram <- read_rds(here("Analysis/models/5-gram_maze.rds")) %>% show_summary() %>% mutate(model="5-gram")
txl <- read_rds(here("Analysis/models/txl_maze.rds")) %>% show_summary() %>% mutate(model="TXL")
grnn <- read_rds(here("Analysis/models/grnn_maze.rds")) %>% show_summary() %>% mutate(model="GRNN")
gpt <- read_rds(here("Analysis/models/gpt_maze.rds")) %>% show_summary() %>% mutate(model="GPT-2")

summ <- ngram %>% union(txl) %>% union(grnn) %>% union(gpt) %>% write_rds(here("Analysis/models/brms_maze_summ.rds"))

```

# Messing around with graphs
```{r play}

show_range<- function(model){
  intervals <- gather_draws(model, `b_.*`, regex=T) %>% mean_qi()
  
  stats <- gather_draws(model, `b_.*`, regex=T) %>% 
    mutate(above_0=ifelse(.value>0, 1,0)) %>% 
    group_by(.variable) %>% 
    summarize(pct_above_0=mean(above_0)) %>% 
    left_join(intervals, by=".variable") 
  
  stats
}
ngram <- read_rds(here("Analysis/models/5-gram_maze.rds")) %>% show_range() %>% mutate(model="5-gram")
txl <- read_rds(here("Analysis/models/txl_maze.rds")) %>% show_range() %>% mutate(model="TXL")
grnn <- read_rds(here("Analysis/models/grnn_maze.rds")) %>% show_range() %>% mutate(model="GRNN")
gpt <- read_rds(here("Analysis/models/gpt_maze.rds")) %>% show_range() %>% mutate(model="GPT-2")

test <- ngram %>% union(txl) %>% union(grnn) %>% union(gpt) %>% write_rds(here("Analysis/models/brms_maze_summ_plot.rds"))

show_range_spr <- function(model){

  stats <- summary(model)[["coefficients"]] %>% 
    as_tibble(rownames="Term") %>% 
    mutate(width=1.97*`Std. Error`,
           lower=Estimate-width,1,
           upper=Estimate+width,1,
           E=Estimate)
  
  stats
}
ngram_spr <- read_rds(here("Analysis/models/5-gram_spr_lmer.rds")) %>% show_range_spr() %>% mutate(model="5-gram")
txl_spr <- read_rds(here("Analysis/models/txl_spr_lmer.rds")) %>% show_range_spr() %>% mutate(model="TXL")
grnn_spr <- read_rds(here("Analysis/models/grnn_spr_lmer.rds")) %>% show_range_spr() %>% mutate(model="GRNN")
gpt_spr <- read_rds(here("Analysis/models/gpt_spr_lmer.rds")) %>% show_range_spr() %>% mutate(model="GPT-2")

range_spr <- ngram_spr %>% union(txl_spr) %>% union(grnn_spr) %>% union(gpt_spr) %>% write_rds(here("Analysis/models/lmer_spr_summ_plot.rds"))
```

```{r}

test_plot_maze <- read_rds(here("Analysis/models/brms_maze_summ_plot.rds")) %>%  mutate(term=str_sub(.variable, 3, -1)) %>% 
   mutate(term=as.factor(term),
          type="Maze",
          Upper=.upper,
          Lower=.lower,
          Estimate=.value,
          time=ifelse(str_detect(term, "prev"),"Previous","Current"),
          term2=mapvalues(term, from=c("Intercept", 
                                 "surprisal",
                                 "len",
                                 "freq",
                                 "surprisal:len",
                                 "len:freq",
                                 "prev_surp",
                                 "prev_len",
                                 "prev_freq",
                                 "prev_surp:prev_len",
                                 "prev_len:prev_freq"), to=c("Intercept", "Surprisal", "Length", "Frequency",
                  "Surp x Length", "Freq x Length", "Surprisal",
                  "Length", "Frequency", "Surp x Length", "Freq x Length")),
          Term=fct_relevel(term2,"Intercept", "Surprisal", "Length", "Frequency", "Surp x Length", "Freq x Length" )) %>% 
  filter(Term!="Intercept") %>% select(model, Term, type, Upper, Lower, Estimate,time)

test_plot_spr <- read_rds(here("Analysis/models/lmer_spr_summ_plot.rds")) %>% mutate(term=as.factor(Term),
          type="SPR",
          Upper=upper,
          Lower=lower,
          time=case_when(
            str_detect(term, "past2")~"2Previous",
            str_detect(term, "past3")~"3Previous",
            str_detect(term, "past")~"Previous",
            T ~ "Current"),
          term2=mapvalues(term, from=c("(Intercept)", 
                                 "surp_center",
                                 "length_center",
                                 "freq_center",
                                 "surp_center:length_center",
                                 "length_center:freq_center",
                                 "past_surp_center",
                                 "past_length_center",
                                 "past_freq_center",
                                 "past_surp_center:past_length_center",
                                 "past_length_center:past_freq_center",
                                 "past2_surp_center",
                                 "past2_length_center",
                                 "past2_freq_center",
                                 "past2_surp_center:past2_length_center",
                                 "past2_length_center:past2_freq_center",
                                 "past3_surp_center",
                                 "past3_length_center",
                                 "past3_freq_center",
                                 "past3_surp_center:past3_length_center",
                                 "past3_length_center:past3_freq_center"
                                 ), to=c("Intercept", "Surprisal", "Length", "Frequency","Surp x Length", "Freq x Length",
                "Surprisal", "Length", "Frequency", "Surp x Length", "Freq x Length",
                "Surprisal", "Length", "Frequency", "Surp x Length", "Freq x Length",
                "Surprisal", "Length", "Frequency", "Surp x Length", "Freq x Length")),
          Term=fct_relevel(term2,"Intercept", "Surprisal", "Length", "Frequency", "Surp x Length", "Freq x Length" )) %>% 
  filter(Term!="Intercept") %>% select(model, Term, type, Upper, Lower, Estimate, time)

test_plot <- test_plot_maze %>% union(test_plot_spr) %>% write_rds(here("Analysis/models/maze_spr_for_graph.rds"))


test_plot %>% filter(time %in% c("Current", "Previous")) %>% ggplot(aes(y=Term, x=Estimate, group=model, color=model, shape=model))+
  ggstance::geom_pointrangeh(aes(xmin = Lower, xmax = Upper), position=position_dodge(width=.6))+facet_grid(type~time)+geom_vline(xintercept=0)+scale_color_brewer(palette="Dark2")+theme(legend.position = "bottom")+labs(x="Coefficient estimate", y="Term", color="Model")
```


# Maze Model comparison

I'm not sure if this is what we want, but these are the P-values from anova's comparison the value of adding one set of surprisal predictors to a model that already has another. (So smaller values mean that the column  has a lot of predictive utility beyond the row label). 

I'm not sure what the best presentational format is -- or whether we want F values or p values or what. I also not sure how to arrange the table (should I transpose?) or label it so which one is better is clear. 

This is all on meaned data with no mixed effects and predictors of freq x length and surprisal(s) for word and previous word. 

```{r}
select_data <- read_rds(here("Data/maze_pre_error.rds")) %>%  select(-starts_with("past2"), -starts_with("past3")) %>% 
  filter(across(everything(),~!is.na(.x))) 


item_mean_data <- select_data %>% 
  group_by(across(c(-subject, -rt))) %>% 
  summarize(rt=mean(rt)) %>% 
  ungroup()

no_surp <- "rt ~ freq_center * length_center + past_freq_center * past_length_center"
ngram <- "+ ngram_center + past_ngram_center"
grnn <- "+ grnn_center + past_grnn_center"
txl <- "+ txl_center + past_txl_center"
gpt <- "+ gpt_center + past_gpt_center"

do_comparison <- function(m1, m2){
  # is there benefit of m2 above m1
  if (m1==m2) {return("")}
  lm1 <- lm(str_c(no_surp,m1), data=item_mean_data)
  lm2 <- lm(str_c(no_surp,m1,m2), data=item_mean_data)
  a <- anova(lm1,lm2)
  fval <- anova(lm1,lm2)$F[2] %>% round() %>%  as.character
  pval <- anova(lm1,lm2)$`Pr(>F)`[2] %>% pvalue(add_p=T) %>% as.character()
  return(str_c(fval," (",pval,")"))
}

log_like <- function(m1){
    lm(str_c(no_surp,m1), data=item_mean_data) %>% logLik() %>% round() %>% as.character()

}


r_squared <- function(m1){
    lm1 <- lm(str_c(no_surp,m1), data=item_mean_data) %>% summary()
    lm1$r.squared %>% round(2) %>% as.character()
}

tibble(Model=c("5-gram","GRNN", "TXL", "GPT-2"), model_str=c(ngram,grnn,txl,gpt),`over 5-gram`=ngram,
             `over GRNN`=grnn,`over TXL`=txl,`over GPT-2`=gpt) %>% 
   mutate(across(`over 5-gram`:`over GPT-2`, ~map2_chr(.x, model_str,do_comparison)),
          `Log Lik`=map_chr(model_str, log_like),
          r_squared=map_chr(model_str, r_squared)) %>% 
   select(-model_str) %>% write_rds(here("Analysis/models/maze_model_compare.rds")) %>%  knitr::kable()

```

# Maze LM with freq**2 effects

Based on GAM viz, we try models with freq**2 effects on item mean data. 

(Tried this with orthagonal polynomials, but I get ridiculous predictions where both the effects for 1st and 2nd order are huge with huge std error, so probably cancelling out?). 

Instead, square and then center raw frequency. This also finds the effects, and seems a little absurd, since it's finding big effects, in opposite directions for squared and not squared. 

```{r}
select_data <- read_rds(here("Data/maze_pre_error.rds")) %>%  select(-starts_with("past2"), -starts_with("past3")) %>% 
  filter(across(everything(),~!is.na(.x))) 


item_mean_data <- select_data %>% 
  group_by(across(c(-subject, -rt))) %>% 
  summarize(rt=mean(rt)) %>% 
  ungroup() %>% 
  mutate(freq_sq_raw=freq**2,
         past_freq_sq_raw=past_freq**2,
         freq_sq=freq_sq_raw-mean(freq_sq_raw, na.rm=T),
         past_freq_sq=past_freq_sq_raw - mean(past_freq_sq_raw, na.rm=T))
         

no_surp_sq <- "rt ~  freq_sq+ freq_center*length_center + past_freq_sq + past_freq_center*past_length_center"
no_surp_poly <- "rt ~ poly(freq_center,2) + length_center+ freq_center:length_center + poly(past_freq_center,2)+past_length_center + past_freq_center:past_length_center"
ngram <- "+ ngram_center + past_ngram_center + ngram_center:length_center +   
  past_ngram_center:past_length_center"
grnn <- "+ grnn_center + past_grnn_center+ grnn_center:length_center +   
  past_grnn_center:past_length_center"
txl <- "+ txl_center + past_txl_center + txl_center:length_center +   
  past_txl_center:past_length_center"
gpt <- "+ gpt_center + past_gpt_center + gpt_center:length_center +   
  past_gpt_center:past_length_center"


lm(str_c(no_surp_sq,ngram), data=item_mean_data) %>% summary()

lm(str_c(no_surp_sq,grnn), data=item_mean_data) %>% summary()
lm(str_c(no_surp_sq,txl), data=item_mean_data) %>% summary()
lm(str_c(no_surp_sq,gpt), data=item_mean_data) %>% summary()

lm(str_c(no_surp_poly,ngram), data=item_mean_data) %>% summary()
lm(str_c(no_surp_poly,grnn), data=item_mean_data) %>% summary()
lm(str_c(no_surp_poly,txl), data=item_mean_data) %>% summary()
lm(str_c(no_surp_poly,gpt), data=item_mean_data) %>% summary()
```

# SPR Prep
```{r read_data, eval=F}
d.raw.a <- here("Data/SPR/batch1_pro.csv") %>% 
  read_csv() 

d.raw.b <- here("Data/SPR/batch2_pro.csv") %>% 
  read_csv()



offset=230 # following note in repo, we have to correct alignment on item 3 b/c an empty token was displayed

d.raw <- d.raw.a %>% union(d.raw.b) %>% 
  mutate(zone=if_else(item == 3 & zone > offset, zone - 3, zone - 2))

# spot check that this matches number wise with their processed words

```

```{r first-story, eval=F}
# to make things more comparable, only look at the first story each participant read

first <- d.raw %>% select(WorkerId,item) %>% unique() %>% 
  group_by(WorkerId) %>% 
  mutate(num=row_number()) %>% 
  filter(num==1) %>% 
  select(-num)

d.limited <- d.raw %>% inner_join(first, by=c("WorkerId","item"))


#d.limited%>% select(WorkerId,correct,item) %>% unique() %>% group_by(correct) %>% tally()  %>% summarize(pct=n/sum(n),correct=correct)

d.good <- d.limited %>% filter(correct>4) %>% rename(rt=RT) %>% filter(rt>100 & rt<5000) %>% write_rds(here("Data/SPR/first.rds"))


```


```{r surprisals, eval=F}

tokenization <- here("Data/SPR/all_stories.tok.txt") %>% 
  read_delim(delim="\t") %>% 
  mutate(Word_In_Story_Num=zone,
         Story_Num=item)

#something is going on is story 2, sentence 4 His brother had blatantly peeked..." 
#they have it as "peaked", not sure what was displayed, but we can inner join
spr_labelled <- select_labs %>% inner_join(tokenization, by=c("word","Word_In_Story_Num","Story_Num")) %>% 
  left_join(d.good, by=c("item","zone")) %>% 
  rename(subject=WorkerId) %>% 
  select(-WorkTimeInSeconds) %>% 
  filter(word_num>1) %>% 
  mutate(Word_ID=as_factor(str_c(Story_Num, Word_In_Story_Num, sep="_")))%>% write_rds(here("Data/clean_spr.rds"))
```

```{r spr item-means}

select_spr <- read_rds(here("Data/clean_spr.rds")) %>% 
  filter(across(everything(),~!is.na(.x))) %>% 
  ungroup()


item_mean_spr <- select_spr %>% 
  group_by(across(c(-subject, -rt))) %>% 
  summarize(rt=mean(rt)) %>% 
  ungroup()


```

# SPR GAMs

```{r for spr gam, eval=T}

ngram_mean_spr <- item_mean_spr %>% rename_with(~str_replace_all(.x, "ngram_", ""))%>%
  select(rt, surp, freq_center, length_center,
         past_surp, past_freq_center, past_length_center,
         past2_surp, past2_freq_center, past2_length_center,
         past3_surp, past3_freq_center, past3_length_center) %>% mutate(model="5-gram")

grnn_mean_spr <- item_mean_spr %>% rename_with(~str_replace_all(.x, "grnn_", ""))%>%
  select(rt, surp, freq_center, length_center,
         past_surp, past_freq_center, past_length_center,
         past2_surp, past2_freq_center, past2_length_center,
         past3_surp, past3_freq_center, past3_length_center) %>% mutate(model="GRNN")

txl_mean_spr <- item_mean_spr %>% rename_with(~str_replace_all(.x, "txl_", ""))%>%
  select(rt, surp, freq_center, length_center,
         past_surp, past_freq_center, past_length_center,
         past2_surp, past2_freq_center, past2_length_center,
         past3_surp, past3_freq_center, past3_length_center) %>% mutate(model="TXL")

gpt_mean_spr<-item_mean_spr %>% rename_with(~str_replace_all(.x, "gpt_", ""))%>%
  select(rt, surp, freq_center, length_center,
         past_surp, past_freq_center, past_length_center,
         past2_surp, past2_freq_center, past2_length_center,
         past3_surp, past3_freq_center, past3_length_center) %>% mutate(model="GPT-2")

all_mean_spr <- ngram_mean_spr %>% union(grnn_mean_spr) %>% union(txl_mean_spr) %>% union(gpt_mean_spr) %>% 
  select(surp, past_surp, past2_surp, past3_surp,model) %>% 
  pivot_longer(cols=`surp`:`past3_surp`) %>% 
  mutate(s=ifelse(name=="surprisal", "Current","Previous")) %>% write_rds(here("Analysis/models/meaned_spr.rds"))
```

```{r spr formulae, echo=T}
#no hierarchical, has freq x len interaction
spr_formula_interact <- rt ~ s(surp, bs="cr", k=20)+
                     ti(length_center, bs="cr")+
                     ti(freq_center,bs="cr")+
                     ti(freq_center,length_center, bs="cr")+
                     s(past_surp, bs="cr", k=20)+
                     ti(past_freq_center, bs="cr")+
                     ti(past_length_center, bs="cr")+
                     ti(past_freq_center, past_length_center, bs="cr")+
                     s(past2_surp, bs="cr", k=20)+
                     ti(past2_freq_center, bs="cr")+
                     ti(past2_length_center, bs="cr")+
                     ti(past2_freq_center, past2_length_center, bs="cr")+
                     s(past3_surp, bs="cr", k=20)+
                     ti(past3_freq_center, bs="cr")+
                     ti(past3_length_center, bs="cr")+
                     ti(past3_freq_center, past3_length_center, bs="cr")



```

All of this is on by-item mean data. 

```{r spr meaned data, cache=T, eval=T}
gam_ngram_1 <- gam(spr_formula_interact, data=ngram_mean_spr, method="REML")
gam_grnn_1 <- gam(spr_formula_interact, data=grnn_mean_spr, method="REML")
gam_txl_1 <- gam(spr_formula_interact, data=txl_mean_spr, method="REML")
gam_gpt_1 <- gam(spr_formula_interact, data=gpt_mean_spr, method="REML")

```

```{r spr bootstrapping, eval=F}
surprisal_range <- seq(0,25,by=0.01)
freq_range <- seq(-9.5,7,by=0.01)
len_range <- seq(-3.4,10.6,by=0.01)
surprisal_terms <- c("surp","past_surp","past2_surp","past3_surp")
freq_terms <- c("freq_center","past_freq_center","past2_freq_center","past3_freq_center")
len_terms <- c("length_center","past_length_center","past2_length_center","past3_length_center")

dat_for_surp_prediction <- expand_grid(surp=seq(0,25,by=0.01),freq_center=0,length_center=0,past_surp=0,past_freq_center=0,past_length_center=0,past2_surp=0,past2_freq_center=0,past2_length_center=0,past3_surp=0,past3_freq_center=0,past3_length_center=0)
dat_for_freq_prediction <- expand_grid(surp=0,freq_center=seq(-9.5,7,by=0.01),length_center=0,past_surp=0,past_freq_center=0,past_length_center=0,past2_surp=0,past2_freq_center=0,past2_length_center=0,past3_surp=0,past3_freq_center=0,past3_length_center=0)
dat_for_length_prediction <- expand_grid(surp=0,freq_center=0,length_center=seq(-3.4,10.6,by=0.01),past_surp=0,past_freq_center=0,past_length_center=0,past2_surp=0,past2_freq_center=0,past2_length_center=0,past3_surp=0,past3_freq_center=0,past3_length_center=0)
dat_for_past_surp_prediction <- expand_grid(surp=0,freq_center=0,length_center=0,past_surp=seq(0,25,by=0.01),past_freq_center=0,past_length_center=0,past2_surp=0,past2_freq_center=0,past2_length_center=0,past3_surp=0,past3_freq_center=0,past3_length_center=0)
dat_for_past_freq_prediction <- expand_grid(surp=0,freq_center=0,length_center=0,past_surp=0,past_freq_center=seq(-9.5,7,by=0.01),past_length_center=0,past2_surp=0,past2_freq_center=0,past2_length_center=0,past3_surp=0,past3_freq_center=0,past3_length_center=0)
dat_for_past_len_prediction <- expand_grid(surp=0,freq_center=0,length_center=0,past_surp=0,past_freq_center=0,past_length_center=seq(-3.4,10.6,by=0.01),past2_surp=0,past2_freq_center=0,past2_length_center=0,past3_surp=0,past3_freq_center=0,past3_length_center=0)
dat_for_past2_surp_prediction <- expand_grid(surp=0,freq_center=0,length_center=0,past_surp=0,past_freq_center=0,past_length_center=0,past2_surp=seq(0,25,by=0.01),past2_freq_center=0,past2_length_center=0,past3_surp=0,past3_freq_center=0,past3_length_center=0)
dat_for_past2_freq_prediction <- expand_grid(surp=0,freq_center=0,length_center=0,past_surp=0,past_freq_center=0,past_length_center=0,past2_surp=0,past2_freq_center=seq(-9.5,7,by=0.01),past2_length_center=0,past3_surp=0,past3_freq_center=0,past3_length_center=0)
dat_for_past2_len_prediction <- expand_grid(surp=0,freq_center=0,length_center=0,past_surp=0,past_freq_center=0,past_length_center=0,past2_surp=0,past2_freq_center=0,past2_length_center=seq(-3.4,10.6,by=0.01),past3_surp=0,past3_freq_center=0,past3_length_center=0)
dat_for_past3_surp_prediction <- expand_grid(surp=0,freq_center=0,length_center=0,past_surp=0,past_freq_center=0,past_length_center=0,past2_surp=0,past2_freq_center=0,past2_length_center=0,past3_surp=seq(0,25,by=0.01),past3_freq_center=0,past3_length_center=0)
dat_for_past3_freq_prediction <- expand_grid(surp=0,freq_center=0,length_center=0,past_surp=0,past_freq_center=0,past_length_center=0,past2_surp=0,past2_freq_center=0,past2_length_center=0,past3_surp=0,past3_freq_center=seq(-9.5,7,by=0.01),past3_length_center=0)
dat_for_past3_len_prediction <- expand_grid(surp=0,freq_center=0,length_center=0,past_surp=0,past_freq_center=0,past_length_center=0,past2_surp=0,past2_freq_center=0,past2_length_center=0,past3_surp=0,past3_freq_center=0,past3_length_center=seq(-3.4,10.6,by=0.01))

term_names <- c("surp","freq_center","length_center","past_surp","past_freq_center","past_length_center","past2_surp","past2_freq_center","past2_length_center","past3_surp","past3_freq_center","past3_length_center")
dats_for_prediction <- list(
  's(surp)'=dat_for_surp_prediction,
  'ti(freq_center)'=dat_for_freq_prediction,
  'ti(length_center)'=dat_for_length_prediction,
  's(past_surp)'=dat_for_past_surp_prediction,
  'ti(past_freq_center)'=dat_for_past_freq_prediction,
  'ti(past_length_center)'=dat_for_past_len_prediction,
  's(past2_surp)'=dat_for_past2_surp_prediction,
  'ti(past2_freq_center)'=dat_for_past2_freq_prediction,
  'ti(past2_length_center)'=dat_for_past2_len_prediction,
  's(past3_surp)'=dat_for_past3_surp_prediction,
  'ti(past3_freq_center)'=dat_for_past3_freq_prediction,
  'ti(past3_length_center)'=dat_for_past3_len_prediction)

N_replicates <- 101
res_ngram_spr <- gam_boot(ngram_mean_spr,spr_formula_interact,dats_for_prediction,N=N_replicates)
bootstrapped_gam_predictions_ngram_spr <- summarize_gam_boot_results(res_ngram_spr,dats_for_prediction,term_names,"5-gram")
res_grnn_spr <- gam_boot(grnn_mean_spr,spr_formula_interact,dats_for_prediction,N=N_replicates)
bootstrapped_gam_predictions_grnn_spr <- summarize_gam_boot_results(res_grnn_spr,dats_for_prediction,term_names,"GRNN")
res_txl_spr <- gam_boot(txl_mean_spr,spr_formula_interact,dats_for_prediction,N=N_replicates)
bootstrapped_gam_predictions_txl_spr <- summarize_gam_boot_results(res_txl_spr,dats_for_prediction,term_names,"Transformer-XL")
res_gpt_spr <- gam_boot(gpt_mean_spr,spr_formula_interact,dats_for_prediction,N=N_replicates)
bootstrapped_gam_predictions_gpt_spr <- summarize_gam_boot_results(res_gpt_spr,dats_for_prediction,term_names,"GPT-2")
all_bootstrapped_predictions_spr <- list(ngram=bootstrapped_gam_predictions_ngram_spr,
                                     grnn=bootstrapped_gam_predictions_grnn_spr,
                                     txl=bootstrapped_gam_predictions_txl_spr,
                                     gpt=bootstrapped_gam_predictions_gpt_spr)
write_rds(all_bootstrapped_predictions_spr,here("Analysis/models/bootstrapped_spr_GAM_predictions.rds"))

term_conversions <- c("surp"="Current","past_surp"="Previous","past2_surp"="2Previous","past3_surp"="3Previous")
all_surprisal_predictions_spr <- rbind(rename(bootstrapped_gam_predictions_ngram_spr[[1]],surprisal=surp),
                                   rename(bootstrapped_gam_predictions_ngram_spr[[4]],surprisal=past_surp),
                                   rename(bootstrapped_gam_predictions_ngram_spr[[7]],surprisal=past2_surp),
                                   rename(bootstrapped_gam_predictions_ngram_spr[[10]],surprisal=past3_surp),
                                   rename(bootstrapped_gam_predictions_grnn_spr[[1]],surprisal=surp),
                                   rename(bootstrapped_gam_predictions_grnn_spr[[4]],surprisal=past_surp),
                                   rename(bootstrapped_gam_predictions_grnn_spr[[7]],surprisal=past2_surp),
                                   rename(bootstrapped_gam_predictions_grnn_spr[[10]],surprisal=past3_surp),
                                   rename(bootstrapped_gam_predictions_txl_spr[[1]],surprisal=surp),
                                   rename(bootstrapped_gam_predictions_txl_spr[[4]],surprisal=past_surp),
                                   rename(bootstrapped_gam_predictions_txl_spr[[7]],surprisal=past2_surp),
                                   rename(bootstrapped_gam_predictions_txl_spr[[10]],surprisal=past3_surp),
                                   rename(bootstrapped_gam_predictions_gpt_spr[[1]],surprisal=surp),
                                   rename(bootstrapped_gam_predictions_gpt_spr[[4]],surprisal=past_surp),
                                   rename(bootstrapped_gam_predictions_gpt_spr[[7]],surprisal=past2_surp),
                                   rename(bootstrapped_gam_predictions_gpt_spr[[10]],surprisal=past3_surp)
                                   ) %>%
  mutate(s=factor(term_conversions[term],levels=term_conversions)) %>%
  select(-term)
write_rds(all_surprisal_predictions_spr,here("Analysis/models/bootstrapped_spr_GAM_surprisal_predictions.rds"))

```

```{r spr-gam-plot}
message("GPT")
plot(gam_gpt_1)
message("GRNN")
plot(gam_grnn_1)
message("TXL")
plot(gam_txl_1)
message("NGRAM")
plot(gam_ngram_1)
```

```{r plot-gam-spr, eval=F}

a <- get_gam_predictions(model=gam_ngram_1, series=surp, series_length=100) %>% select(surprisal=surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="5-gram", s="Current")
b <- get_gam_predictions(model=gam_ngram_1, series=past_surp, series_length=100) %>% select(surprisal=past_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="5-gram", s="Previous")
c <- get_gam_predictions(model=gam_ngram_1, series=past2_surp, series_length=100) %>% select(surprisal=past2_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="5-gram", s="2Previous")
d <- get_gam_predictions(model=gam_ngram_1, series=past3_surp, series_length=100) %>% select(surprisal=past3_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="5-gram", s="3Previous")

e <- get_gam_predictions(model=gam_grnn_1, series=surp, series_length=100) %>% select(surprisal=surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="GRNN", s="Current")
f <- get_gam_predictions(model=gam_grnn_1, series=past_surp, series_length=100) %>% select(surprisal=past_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="GRNN", s="Previous")
g <- get_gam_predictions(model=gam_grnn_1, series=past2_surp, series_length=100) %>% select(surprisal=past2_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="GRNN", s="2Previous")
h <- get_gam_predictions(model=gam_grnn_1, series=past3_surp, series_length=100) %>% select(surprisal=past3_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="GRNN", s="3Previous")

i <- get_gam_predictions(model=gam_txl_1, series=surp, series_length=100) %>% select(surprisal=surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="TXL", s="Current")
j <- get_gam_predictions(model=gam_txl_1, series=past_surp, series_length=100) %>% select(surprisal=past_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="TXL", s="Previous")
k <- get_gam_predictions(model=gam_txl_1, series=past2_surp, series_length=100) %>% select(surprisal=past2_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="TXL", s="2Previous")
l <- get_gam_predictions(model=gam_txl_1, series=past3_surp, series_length=100) %>% select(surprisal=past3_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="TXL", s="3Previous")

m <- get_gam_predictions(model=gam_gpt_1, series=surp, series_length=100) %>% select(surprisal=surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="GPT-2", s="Current")
n <- get_gam_predictions(model=gam_gpt_1, series=past_surp, series_length=100) %>% select(surprisal=past_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="GPT-2", s="Previous")
o <- get_gam_predictions(model=gam_gpt_1, series=past2_surp, series_length=100) %>% select(surprisal=past2_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="GPT-2", s="2Previous")
p <- get_gam_predictions(model=gam_gpt_1, series=past3_surp, series_length=100) %>% select(surprisal=past3_surp, rt, CI_upper, CI_lower) %>% unique() %>% mutate(model="GPT-2", s="3Previous")


all <- a %>% union(b) %>% union(c) %>% union(d) %>% union(e) %>% union(f) %>% union(g) %>% union(h) %>% 
   union(i) %>% union(j) %>% union(k) %>% union(l) %>% union(m) %>% union(n) %>% union(o) %>% union(p) %>% 
  mutate(model=factor(model, levels=c("5-gram", "GRNN", "TXL","GPT-2")),
         s=factor(s, levels=c("Current", "Previous", "2Previous", "3Previous"))) %>% 
                        write_rds(here("Analysis/models/spr_gam_predictions.rds"))
```

```{r, eval=T}
all_mean_spr <-  read_rds(here("Analysis/models/meaned_spr.rds"))


#gam1 <- read_rds(here("Analysis/models/spr_gam_predictions.rds")) %>%  
gam1 <- read_rds(here("Analysis/models/bootstrapped_spr_GAM_surprisal_predictions.rds")) %>%  
  ggplot( aes(x=surprisal, y=rt, ymin=CI_lower, ymax=CI_upper))+
  geom_line()+
  geom_ribbon(alpha=.3)+
  facet_grid(s~model)+
  coord_cartesian(xlim=c(0,28))+
  labs(x="Surprisal (bits)", y="Reaction Time (ms)")+theme(axis.ticks.x=element_blank(), axis.title.x=element_blank(), axis.text.x=element_blank(), plot.margin=margin(t=0,r=0,b=0,l=0,unit="pt"))


dens2 <-   ggplot(all_mean_spr, aes(x=value))+
  geom_density(fill="gray",)+
  facet_grid(.~model)+
  labs(x="Surprisal (bits)", y="")+
    coord_cartesian(xlim=c(0,28))+
  theme(axis.text.y = element_blank(), strip.text=element_blank(), axis.ticks.y =element_blank(), axis.title.y=element_blank(), panel.grid=element_blank(), plot.margin = unit(c(0, 0, 0, 0), "cm"))

p2 = cowplot::align_plots(gam1, dens2, align = "v", axis="lr")
plot_grid(p2[[1]], p2[[2]], nrow=2, rel_heights = c(1, .3))

```


# SPR LMs

```{r, eval=F}

select_spr <- read_rds(here("Data/clean_spr.rds")) %>% 
  filter(across(everything(),~!is.na(.x))) %>% 
  ungroup()


item_mean_spr <- select_spr %>% 
  group_by(across(c(-subject, -rt))) %>% 
  summarize(rt=mean(rt)) %>% 
  ungroup()

ngram_data <- select_spr %>% rename_with(~str_replace_all(.x, "ngram", "surp"))%>% 
  select(rt, surp_center, freq_center, length_center,
         past_surp_center, past_freq_center, past_length_center,
         past2_surp_center, past2_freq_center, past2_length_center,
         past3_surp_center, past3_freq_center, past3_length_center, subject, Word_ID) %>% mutate(model="5-gram") 

grnn_data <- select_spr %>% rename_with(~str_replace_all(.x, "grnn", "surp"))%>% 
  select(rt, surp_center, freq_center, length_center,
         past_surp_center, past_freq_center, past_length_center,
         past2_surp_center, past2_freq_center, past2_length_center,
         past3_surp_center, past3_freq_center, past3_length_center, subject, Word_ID)%>% mutate(model="GRNN")

txl_data <- select_spr %>% rename_with(~str_replace_all(.x, "txl", "surp"))%>% 
  select(rt, surp_center, freq_center, length_center,
         past_surp_center, past_freq_center, past_length_center,
         past2_surp_center, past2_freq_center, past2_length_center,
         past3_surp_center, past3_freq_center, past3_length_center, subject, Word_ID) %>% mutate(model="TXL")

gpt_data <-select_spr %>% rename_with(~str_replace_all(.x, "txl", "surp"))%>% 
  select(rt, surp_center, freq_center, length_center,
         past_surp_center, past_freq_center, past_length_center,
         past2_surp_center, past2_freq_center, past2_length_center,
         past3_surp_center, past3_freq_center, past3_length_center, subject, Word_ID) %>% mutate(model="GPT-2")

all_spr <- ngram_data %>% union(grnn_data) %>% union(txl_data) %>% union(gpt_data) %>% 
  write_rds(here("Analysis/models/spr_pre_brms.rds"))

ngram_mean_data <- item_mean_spr %>% rename_with(~str_replace_all(.x, "ngram", "surp"))%>% 
  select(rt, surp_center, freq_center, length_center,
         past_surp_center, past_freq_center, past_length_center,
         past2_surp_center, past2_freq_center, past2_length_center,
         past3_surp_center, past3_freq_center, past3_length_center, Word_ID) %>% mutate(model="5-gram") 

grnn_mean_data <- item_mean_spr %>% rename_with(~str_replace_all(.x, "grnn", "surp"))%>% 
  select(rt, surp_center, freq_center, length_center,
         past_surp_center, past_freq_center, past_length_center,
         past2_surp_center, past2_freq_center, past2_length_center,
         past3_surp_center, past3_freq_center, past3_length_center, Word_ID)%>% mutate(model="GRNN")

txl_mean_data <- item_mean_spr %>% rename_with(~str_replace_all(.x, "txl", "surp"))%>% 
  select(rt, surp_center, freq_center, length_center,
         past_surp_center, past_freq_center, past_length_center,
         past2_surp_center, past2_freq_center, past2_length_center,
         past3_surp_center, past3_freq_center, past3_length_center, Word_ID) %>% mutate(model="TXL")

gpt_mean_data <-item_mean_spr %>% rename_with(~str_replace_all(.x, "txl", "surp"))%>% 
  select(rt, surp_center, freq_center, length_center,
         past_surp_center, past_freq_center, past_length_center,
         past2_surp_center, past2_freq_center, past2_length_center,
         past3_surp_center, past3_freq_center, past3_length_center, Word_ID) %>% mutate(model="GPT-2")

all_mean_spr_center <- ngram_mean_data %>% union(grnn_mean_data) %>% union(txl_mean_data) %>% union(gpt_mean_data) %>% write_rds(here("Analysis/models/mean_spr_center.rds"))

```

```{r spr lms-mean, eval=T}

all_mean_spr_center <- read_rds(here("Analysis/models/mean_spr_center.rds"))
run_lm <- function(data,modelspec){
  d <- data %>% filter(model==modelspec)
model_1 <- lmer(rt ~ surp_center * length_center + length_center * freq_center +
                  past_surp_center * past_length_center + past_length_center * past_freq_center + 
                 past2_surp_center * past2_length_center + past2_length_center * past2_freq_center + 
                  past3_surp_center * past3_length_center + past3_length_center * past3_freq_center +(1|Word_ID), data=d)
return(model_1)
}

m_ngram <- run_lm(all_mean_spr_center,"5-gram")
m_grnn <- run_lm(all_mean_spr_center, "GRNN")
m_txl <- run_lm(all_mean_spr_center,"TXL")
m_gpt <- run_lm(all_mean_spr_center,"GPT-2")

```

```{r lmsumm}
summary(m_ngram)
summary(m_grnn)
summary(m_txl)
summary(m_gpt)
```



```{r, eval=F}

#data=readRDS("spr_pre_brms.rds")
data=read_rds(here("Analysis/models/spr_pre_brms.rds"))

run_model_lmer <- function(model_spec,data){
  d <- data %>% filter(model==model_spec)
  m1 <- lmer(rt ~ surp_center * length_center + length_center * freq_center +
                  past_surp_center * past_length_center + past_length_center * past_freq_center + 
                 past2_surp_center * past2_length_center + past2_length_center * past2_freq_center + 
                  past3_surp_center * past3_length_center + past3_length_center * past3_freq_center + 
              (surp_center + length_center +  freq_center +
                  past_surp_center + past_length_center + past_freq_center ||subject)+(1|Word_ID),
            data=d) 
  m1
}

run_model_lmer("GRNN",data) %>% write_rds(here("Analysis/models/grnn_spr_lmer.rds"))
run_model_lmer("5-gram",data) %>% write_rds(here("Analysis/models/5-gram_spr_lmer.rds"))
run_model_lmer("TXL",data) %>% write_rds(here("Analysis/models/txl_spr_lmer.rds"))
run_model_lmer("GPT-2",data) %>% write_rds(here("Analysis/models/gpt_spr_lmer.rds"))

```
## Summaries of LMER 
These have some hierarchical effects


```{r summary-spr}

show_summary_spr <- function(model){

  stats <- summary(model)[["coefficients"]] %>% 
    as_tibble(rownames="Term") %>% 
    mutate(width=1.97*`Std. Error`,
           lower=round(Estimate-width,1),
           upper=round(Estimate+width,1),
           E=round(Estimate, digits=1),
           `Estimate`=str_c(E," [",lower,", ", upper,"]")
           ) %>% 
    select(Term, Estimate)
  
  stats
}
```

```{r process-spr-models, eval=F}
ngram_spr <- read_rds(here("Analysis/models/5-gram_spr_lmer.rds")) %>% show_summary_spr() %>% mutate(model="5-gram")
txl_spr <- read_rds(here("Analysis/models/txl_spr_lmer.rds")) %>% show_summary_spr() %>% mutate(model="TXL")
grnn_spr <- read_rds(here("Analysis/models/grnn_spr_lmer.rds")) %>% show_summary_spr() %>% mutate(model="GRNN")
gpt_spr <- read_rds(here("Analysis/models/gpt_spr_lmer.rds")) %>% show_summary_spr() %>% mutate(model="GPT-2")

summ_spr <- ngram_spr %>% union(txl_spr) %>% union(grnn_spr) %>% union(gpt_spr) %>% write_rds(here("Analysis/models/lmer_spr_summ.rds"))

```


# SPR Model comparison

I'm not sure if this is what we want, but these are the P-values from anova's comparison the value of adding one set of surprisal predictors to a model that already has another. (So smaller values mean that the column  has a lot of predictive utility beyond the row label). 

I'm not sure what the best presentational format is -- or whether we want F values or p values or what. I also not sure how to arrange the table (should I transpose?) or label it so which one is better is clear. 

This is all on meaned data with no mixed effects and predictors of freq x length and surprisal(s) for word and previous word. 

```{r}
select_spr <- read_rds(here("Data/clean_spr.rds")) %>% 
  filter(across(everything(),~!is.na(.x))) %>% 
  ungroup()


item_mean_spr <- select_spr %>% 
  group_by(across(c(-subject, -rt))) %>% 
  summarize(rt=mean(rt)) %>% 
  ungroup()


no_surp <- "rt ~ freq_center * length_center + 
            past_freq_center * past_length_center + 
            past2_freq_center * past2_length_center + 
            past3_freq_center * past3_length_center "
ngram <- "+ ngram_center + past_ngram_center + past2_ngram_center + past3_ngram_center"
grnn <- "+ grnn_center + past_grnn_center +past2_grnn_center +past3_grnn_center"
txl <- "+ txl_center + past_txl_center +past2_txl_center + past3_txl_center"
gpt <- "+ gpt_center + past_gpt_center + past2_gpt_center + + past3_gpt_center"

do_comparison <- function(m1, m2){
  # is there benefit of m2 above m1
  if (m1==m2) {return("")}
  lm1 <- lm(str_c(no_surp,m1), data=item_mean_spr)
  lm2 <- lm(str_c(no_surp,m1,m2), data=item_mean_spr)
  a <- anova(lm1,lm2)
  fval <- anova(lm1,lm2)$F[2] %>% round() %>%  as.character
  pval <- anova(lm1,lm2)$`Pr(>F)`[2] %>% pvalue(add_p=T) %>% as.character()
  return(str_c(fval," (",pval,")"))
  #return(a)
}

#do_comparison(ngram, grnn)
log_like <- function(m1){
    lm(str_c(no_surp,m1), data=item_mean_spr) %>% logLik() %>% round() %>% as.character()

}

r_squared <- function(m1){
    lm1 <- lm(str_c(no_surp,m1), data=item_mean_spr) %>% summary()
    lm1$r.squared %>% round(3) %>% as.character()
}


tibble(Model=c("5-gram","GRNN", "TXL", "GPT-2"), model_str=c(ngram,grnn,txl,gpt),`over 5-gram`=ngram,
             `over GRNN`=grnn,`over TXL`=txl,`over GPT-2`=gpt) %>% 
   mutate(across(`over 5-gram`:`over GPT-2`, ~map2_chr(.x, model_str,do_comparison)),
          `Log Lik`=map_chr(model_str, log_like),
          `r_squared`=map_chr(model_str, r_squared)) %>% 
   select(-model_str)%>% write_rds(here("Analysis/models/spr_model_compare.rds")) %>% kable() 

```
# SPR LM with freq**2 effects

```{r}
select_spr <- read_rds(here("Data/clean_spr.rds")) %>% 
  filter(across(everything(),~!is.na(.x))) %>% 
  ungroup()


item_mean_spr <- select_spr %>% 
  group_by(across(c(-subject, -rt))) %>% 
  summarize(rt=mean(rt)) %>% 
  ungroup()



no_surp_poly <- "rt ~ poly(freq_center,2) + length_center+ freq_center:length_center + poly(past_freq_center,2)+past_length_center + past_freq_center:past_length_center+
poly(past2_freq_center,2)+past2_length_center + past2_freq_center:past2_length_center+
poly(past3_freq_center,2)+past3_length_center + past3_freq_center:past3_length_center"
ngram <- "+ ngram_center + past_ngram_center + past2_ngram_center + past3_ngram_center+
ngram_center:length_center + past_ngram_center:past_length_center+ past2_ngram_center:past2_length_center+past3_ngram_center:past3_length_center"
grnn <- "+ grnn_center + past_grnn_center +past2_grnn_center +past3_grnn_center +grnn_center:length_center + past_grnn_center:past_length_center+ past2_grnn_center:past2_length_center+past3_grnn_center:past3_length_center"
txl <- "+ txl_center + past_txl_center +past2_txl_center + past3_txl_center +
txl_center:length_center + past_txl_center:past_length_center+ past2_txl_center:past2_length_center+past3_txl_center:past3_length_center"
gpt <- "+ gpt_center + past_gpt_center + past2_gpt_center + + past3_gpt_center+
gpt_center:length_center + past_gpt_center:past_length_center+ past2_gpt_center:past2_length_center+past3_gpt_center:past3_length_center"

lm(str_c(no_surp_poly,ngram), data=item_mean_spr) %>% summary()
lm(str_c(no_surp_poly,grnn), data=item_mean_spr) %>% summary()
lm(str_c(no_surp_poly,txl), data=item_mean_spr) %>% summary()
lm(str_c(no_surp_poly,gpt), data=item_mean_spr) %>% summary()
```

# Maze and SPR scatter

```{r}
tokenization <- here("Data/SPR/all_stories.tok.txt") %>% 
  read_delim(delim="\t") %>% 
  mutate(Word_In_Story_Num=zone,
         Story_Num=item)

labs <- read_rds(here("Prep_code/natural_stories_surprisals.rds")) %>% 
  left_join(read_delim(here("Materials/natural_stories_sentences.tsv"), delim="\t")) %>% 
  select(word_num=Word_In_Sentence_Num, word=Word, sentence=Sentence, everything())

spr <- read_rds(here("Data/SPR/first.rds")) %>% left_join(tokenization) %>% left_join(labs) %>% select(WorkerId,rt,Story_Num,Sentence_Num, word_num)

maze <- read_rds(here("Data/maze_pre_error.rds")) %>% left_join(labs) %>% select(subject, rt, Story_Num, Sentence_Num, word_num)
```

Abnormally low and high times were excluded, then for each word, an average was taken across subjects. For sentence level, these averages were then summed across the sentence. (Because of A-maze sentence discontinuation and general outlier handling, summing the average is better than averaging the sum.)

We want to compare w/i Maze, w/i SPR and between Maze and SPR. Maze is the smaller dataset (63 subjects), so we split half for each story. 

For SPR, we subsample the 165 subjects down to 63 (to match the number of subjects in Maze), and again split half for each story. 

For Maze-SPR comparison, we compare each of the Maze half-SPR half and then average the correlations across these 4 pairs. 

### SPR-SPR

```{r spr-split-half}
set.seed(42)
spr_subs <- spr %>% filter(!is.na(Story_Num)) %>% select(WorkerId, Story_Num) %>% unique() %>% sample_n(63) %>%  group_by(Story_Num) %>%
  mutate(half=ifelse(row_number() <= .5*n(),"spr1", "spr2"))
#180 participants


spr_split <- spr %>%
  inner_join(spr_subs) %>% 
  group_by(half,Story_Num, Sentence_Num, word_num) %>% summarize(spr=mean(rt)) %>% 
  pivot_wider(names_from=half, values_from=spr)
  
ggplot(spr_split, aes(x=spr1, y=spr2))+
  geom_point(alpha=.02)+
  coord_cartesian(xlim=c(0,600),ylim=c(0,600))+
  labs(title="Word level correlation in ms",subtitle="Axes trimmed")

cor(spr_split$spr1,spr_split$spr2, use="complete.obs")
spr_sentence <- spr_split %>% group_by(Story_Num, Sentence_Num) %>% 
  summarize(spr1=sum(spr1)/1000,
            spr2=sum(spr2)/1000)

ggplot(spr_sentence, aes(x=spr1, y=spr2))+geom_point(alpha=.1)+
  labs(title="Sentence level correlation in s")

cor(spr_sentence$spr1,spr_sentence$spr2, use="complete.obs")

spr_sentence_avg <- spr_split%>% group_by(Story_Num, Sentence_Num) %>% 
  summarize(spr1=mean(spr1),
            spr2=mean(spr2))
ggplot(spr_sentence_avg, aes(x=spr1, y=spr2))+geom_point(alpha=.1)+
    coord_cartesian(xlim=c(0,600),ylim=c(0,600))+
  labs(title="Sentence level correlation in ms")

cor(spr_sentence_avg$spr1,spr_sentence_avg$spr2, use="complete.obs")
```
### Maze-Maze

```{r maze-split-half}
set.seed(42)
maze_subs <- maze %>% select(subject, Story_Num) %>% unique() %>% sample_n(63)%>% group_by(Story_Num) %>%
  mutate(half=ifelse(row_number() <= .5*n(),"maze1", "maze2"))

maze_split <- maze %>% 
  left_join(maze_subs) %>% 
  group_by(half,Story_Num, Sentence_Num, word_num) %>% summarize(maze=mean(rt)) %>% 
  pivot_wider(names_from=half, values_from=maze)
  
ggplot(maze_split, aes(x=maze1, y=maze2))+
  geom_point(alpha=.02)+
  coord_cartesian(xlim=c(0,1500),ylim=c(0,1500))+
  labs(title="Word level correlation in ms",subtitle="Axes trimmed")

cor(maze_split$maze1,maze_split$maze2, use="complete.obs")
maze_sentence <- maze_split %>% group_by(Story_Num, Sentence_Num) %>% 
  summarize(maze1=sum(maze1)/1000,
            maze2=sum(maze2)/1000)

ggplot(maze_sentence, aes(x=maze1, y=maze2))+geom_point(alpha=.1)+
  labs(title="Sentence level correlation in s")

cor(maze_sentence$maze1,maze_sentence$maze2, use="complete.obs")

maze_sentence_avg <- maze_split%>% group_by(Story_Num, Sentence_Num) %>% 
  summarize(maze1=mean(maze1),
            maze2=mean(maze2))
ggplot(maze_sentence_avg, aes(x=maze1, y=maze2))+geom_point(alpha=.1)+
    coord_cartesian(xlim=c(0,1500),ylim=c(0,1500))+
  labs(title="Sentence level correlation in ms")

cor(maze_sentence_avg$maze1,maze_sentence_avg$maze2, use="complete.obs")
```

### Maze-SPR
For maze-spr comparisons we take the 4 pairs (maze1 with spr1; maze1 with spr2, etc) We overplot all the combinations (not sure this is right), and take the average of the 4 correlations. 

```{r maze-spr}
summ_spr <- spr %>% inner_join(spr_subs)%>% group_by(Story_Num, Sentence_Num, word_num,half) %>% summarize(spr=mean(rt, na.rm=T)) %>% rename(spr_half=half) %>% filter(!is.na(spr))
  
summ <- maze %>% inner_join(maze_subs) %>% group_by(Story_Num, Sentence_Num, word_num, half) %>% summarize(maze=mean(rt, na.rm=T)) %>% rename(maze_half=half) %>% filter(!is.na(maze))%>% inner_join(summ_spr)

summ11 <- summ %>% filter(maze_half=="maze1" & spr_half=="spr1")
summ12 <- summ %>% filter(maze_half=="maze1" & spr_half=="spr2")
summ21 <- summ %>% filter(maze_half=="maze2" & spr_half=="spr1")
summ22 <- summ %>% filter(maze_half=="maze2" & spr_half=="spr2")

ggplot(summ, aes(x=maze, y=spr))+
  geom_point(alpha=.02)+
  coord_cartesian(xlim=c(0,1500),ylim=c(0,600))+
  labs(title="Word level correlation in ms",subtitle="Axes trimmed")

mean(c(cor(summ11$spr,summ11$maze, use="complete.obs"),
  cor(summ12$spr,summ12$maze, use="complete.obs"),
  cor(summ21$spr,summ21$maze, use="complete.obs"),
  cor(summ22$spr,summ22$maze, use="complete.obs")))


sentence <- summ %>% group_by(Story_Num, Sentence_Num, maze_half, spr_half) %>% 
  summarize(maze=sum(maze)/1000,
            spr=sum(spr)/1000)

sentence11 <- sentence %>% filter(maze_half=="maze1" & spr_half=="spr1")
sentence12 <- sentence %>% filter(maze_half=="maze1" & spr_half=="spr2")
sentence21 <- sentence %>% filter(maze_half=="maze2" & spr_half=="spr1")
sentence22 <- sentence %>% filter(maze_half=="maze2" & spr_half=="spr2")

ggplot(sentence, aes(x=maze, y=spr))+geom_point(alpha=.1)+
  labs(title="Sentence level correlation in s")

 mean(c(cor(sentence11$spr,sentence11$maze, use="complete.obs"),
  cor(sentence12$spr,sentence12$maze, use="complete.obs"),
  cor(sentence21$spr,sentence21$maze, use="complete.obs"),
  cor(sentence22$spr,sentence22$maze, use="complete.obs")))

sentence_avg <- summ %>% group_by(Story_Num, Sentence_Num, maze_half, spr_half) %>% 
  summarize(maze=mean(maze),
            spr=mean(spr))

sentence_avg11 <- sentence_avg %>% filter(maze_half=="maze1" & spr_half=="spr1")
sentence_avg12 <- sentence_avg %>% filter(maze_half=="maze1" & spr_half=="spr2")
sentence_avg21 <- sentence_avg %>% filter(maze_half=="maze2" & spr_half=="spr1")
sentence_avg22 <- sentence_avg %>% filter(maze_half=="maze2" & spr_half=="spr2")

ggplot(sentence_avg, aes(x=maze, y=spr))+geom_point(alpha=.1)+
    coord_cartesian(xlim=c(0,1500),ylim=c(0,600))+
  labs(title="Sentence level correlation in ms")

  mean(c(cor(sentence_avg11$spr,sentence_avg11$maze, use="complete.obs"),
  cor(sentence_avg12$spr,sentence_avg12$maze, use="complete.obs"),
  cor(sentence_avg21$spr,sentence_avg21$maze, use="complete.obs"),
  cor(sentence_avg22$spr,sentence_avg22$maze, use="complete.obs")))
```